import express, { Request, Response } from "express";
import Stripe from "stripe";
import admin from "firebase-admin";

// ConfiguraÃ§Ã£o do Stripe
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY as string, {
  apiVersion: "2022-11-15",
});

const app = express();

// Garante que o rawBody Ã© recebido corretamente
app.post(
  "/api/stripe-webhook",
  express.raw({ type: "application/json" }),
  async (req: Request, res: Response) => {
    const sig = req.headers["stripe-signature"] as string;
    let event;

    try {
      event = stripe.webhooks.constructEvent(
        req.body, // Verifique se o rawBody estÃ¡ sendo recebido corretamente
        sig,
        process.env.STRIPE_WEBHOOK_SECRET!
      );
      console.log("âœ… Webhook Recebido:", event.type);
    } catch (err) {
      console.error("âŒ Erro de verificaÃ§Ã£o do webhook:", err);
      return res.status(400).send(`Webhook Error: ${err.message}`);
    }

    // ManipulaÃ§Ã£o dos eventos
    switch (event.type) {
      case "checkout.session.completed":
        const session = event.data.object;
        console.log("âœ… Evento de checkout.session.completed recebido:", session);
        await criarUsuarioFirebase(session);
        break;
      default:
        console.log(`Evento nÃ£o tratado: ${event.type}`);
    }

    res.status(200).send("Webhook processado com sucesso.");
  }
);

// FunÃ§Ã£o para criar usuÃ¡rio no Firebase
const criarUsuarioFirebase = async (session: any) => {
  try {
    console.log("ðŸ“Œ Criando usuÃ¡rio no Firebase para:", session.customer_email);

    const userRecord = await admin.auth().createUser({
      email: session.customer_email,
      password: "senha_aleatoria_segura",
      displayName: "Novo UsuÃ¡rio",
    });

    console.log("âœ… UsuÃ¡rio criado no Firebase:", userRecord.uid);
  } catch (error) {
    console.error("âŒ Erro ao criar usuÃ¡rio no Firebase:", error);
  }
};

// Inicializa o servidor
app.listen(3000, () => {
  console.log("Servidor rodando na porta 3000");
});
