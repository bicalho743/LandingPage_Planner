// 🔧 Firebase Backend Configuration (server/firebase.ts)
import admin from 'firebase-admin';

// Verifica se o Firebase Admin já está inicializado
if (!admin.apps.length) {
  const serviceAccount = JSON.parse(process.env.FIREBASE_ADMIN_CREDENTIALS!);
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
  });
}

// Exportando funções úteis
export const firebaseAuth = admin.auth();
export const firebaseDb = admin.firestore();

// 🔧 PostgreSQL Configuration (server/db.ts)
import pg from 'pg';

const { Pool } = pg;
const DATABASE_URL = process.env.DATABASE_URL!;

const pool = new Pool({
  connectionString: DATABASE_URL,
  ssl: { rejectUnauthorized: false },
});

export default pool;

// 🔧 Stripe Webhook Handling (server/stripe-webhook.ts)
import { firebaseAuth } from './firebase';

// Criação de usuário após pagamento bem-sucedido
app.post('/api/stripe-webhook', async (req, res) => {
  const event = req.body;
  if (event.type === 'checkout.session.completed') {
    const email = event.data.object.customer_email;
    try {
      await firebaseAuth.createUser({ email, password: 'senhaSegura123!' });
      console.log(`✅ Usuário criado no Firebase: ${email}`);
    } catch (error) {
      console.error(`❌ Erro ao criar usuário no Firebase: ${error.message}`);
    }
  }
  res.status(200).send('Webhook recebido com sucesso');
});

// 🔧 Firebase Frontend Configuration (client/src/lib/firebase.ts)
import { initializeApp } from "firebase/app";
import { getAuth, createUserWithEmailAndPassword } from "firebase/auth";

const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: `${import.meta.env.VITE_FIREBASE_PROJECT_ID}.firebaseapp.com`,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
};

const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);

// 🔧 Stripe Checkout Success (client/src/pages/sucesso.tsx)
import { useEffect } from "react";
import { auth, createUserWithEmailAndPassword } from "../lib/firebase";

export default function Sucesso() {
  useEffect(() => {
    const email = localStorage.getItem("email");
    if (email) {
      createUserWithEmailAndPassword(auth, email, "senhaSegura123!")
        .then(() => console.log("✅ Usuário autenticado no Firebase."))
        .catch(console.error);
    }
  }, []);

  return <h1>✅ Pagamento bem-sucedido! Usuário autenticado.</h1>;
}
